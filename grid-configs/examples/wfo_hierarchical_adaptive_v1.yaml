# Walk-Forward Optimization Configuration for Hierarchical Adaptive v1.0
# ==========================================================================
# This configuration uses WFO methodology to validate strategy robustness
# and prevent curve-fitting.
#
# WFO Process:
# 1. Divide 15-year period into sliding 3-year windows
# 2. Each window: 2.5y in-sample (optimize) + 0.5y out-of-sample (test)
# 3. Slide forward 0.5y and repeat
# 4. Stitch all OOS results together for true performance
#
# This ensures parameters are re-optimized periodically (mimicking real trading)
# and performance is measured ONLY on unseen future data.
#
# Strategy Overview:
# - TIER 0: VIX Volatility Filter (master switch) - NEW
# - TIER 1: Kalman Filter Trend Strength Oscillator (-100 to +100)
# - TIER 2: 4 Regimes: Strong Bull, Moderate Bull, Chop/Neutral, Bear
# - TIER 3: 4 Trading Vehicles: TQQQ (3x long), QQQ (1x), SQQQ (3x inverse), CASH
# - TIER 4: Regime-Specific Logic: Each regime has different EMA/MACD parameters

# Strategy to optimize (same as grid search)
strategy: "Hierarchical_Adaptive_v1"

# Symbol Sets (same as grid search with VIX)
# ---------------------------------
symbol_sets:
  - name: "QQQ_TQQQ_SQQQ_VIX"
    signal_symbol: "QQQ"      # Kalman filter calculations
    bull_symbol: "TQQQ"       # 3x leveraged long for aggressive regime
    defense_symbol: "QQQ"     # 1x for moderate regime
    bear_symbol: "SQQQ"       # 3x inverse for bear regime
    vix_symbol: "VIX"         # Volatility filter (master switch) - NEW

# Base Configuration
# ------------------
# Note: start_date and end_date here are IGNORED for WFO
# WFO uses walk_forward.total_start_date and total_end_date instead
base_config:
  # Market data
  timeframe: "1D"

  # Portfolio settings
  initial_capital: 100000  # Matches strategy spec ($100,000)
  commission: 0.0          # Strategy spec: $0.00 per trade
  slippage: 0.0005         # Strategy spec: 0.05% per trade

# Parameters to Optimize
# ----------------------
# REDUCED PARAMETER SET for WFO (to keep runtime reasonable)
# WFO runs multiple grid searches (one per window), so we use smaller ranges
# USER CONFIGURABLE: Expand cautiously (increases runtime significantly)
#
# Current combinations per window: 2 * 2 * 2 * 2 * 2 * 2 * 2 * 2 * 2 * 2 = 256
# Total windows: ~29
# Total backtests: 29 * 256 = 7,424
# Estimated runtime: 6-10 hours

parameters:
  # ============================================================================
  # TIER 0: VIX VOLATILITY FILTER (Master Risk Switch) - NEW
  # ============================================================================
  # Test 2 VIX EMA periods for WFO validation
  # Based on grid-search results, select 2 most promising values
  # Default: [20, 50] (fast vs medium-reacting)

  vix_ema_period: [20, 50]  # NEW PARAMETER (2 values)

  # ============================================================================
  # TIER 1: KALMAN FILTER PARAMETERS (Reduced for WFO)
  # ============================================================================
  # Starting with 2 values each for faster WFO iteration
  # Based on grid-search winners

  measurement_noise: [2000.0, 5000.0]  # Grid-search had [2000, 5000, 10000], reduced
  osc_smoothness: [15, 20]             # Grid-search had [15, 20, 30], reduced
  strength_smoothness: [15, 20]        # Grid-search had [15, 20, 30], reduced

  # Fixed at defaults (not optimized in WFO)
  process_noise_1: [0.01]              # Fixed
  process_noise_2: [0.01]              # Fixed

  # ============================================================================
  # TIER 2: REGIME THRESHOLD PARAMETERS (Reduced for WFO)
  # ============================================================================
  # Starting with 2 threshold combinations
  # Based on grid-search results

  thresh_strong_bull: [60, 70]         # Grid-search had [60, 70], keep both
  thresh_moderate_bull: [20]           # Fixed at default
  thresh_moderate_bear: [-20]          # Fixed at default

  # ============================================================================
  # TIER 3: RISK MANAGEMENT PARAMETERS (Reduced for WFO)
  # ============================================================================

  atr_stop_multiplier: [2.0, 2.5]      # Grid-search had [2.0, 2.5], keep both
  risk_leveraged: [0.02, 0.025]        # Grid-search had [0.015, 0.02, 0.025], reduced
  allocation_unleveraged: [0.8]        # Fixed at default

  # ============================================================================
  # TIER 4: REGIME-SPECIFIC PARAMETERS (Reduced for WFO)
  # ============================================================================
  # These remain mostly fixed to reduce combinatorial explosion
  # Focus WFO on VIX filter, Kalman filter, and threshold optimization
  # Can expand based on grid-search results

  # Strong Bull Regime
  ema_trend_sb: [100]                  # Fixed (expand based on grid-search if needed)
  macd_fast_sb: [12]                   # Fixed
  macd_slow_sb: [26]                   # Fixed
  macd_signal_sb: [9]                  # Fixed

  # Moderate Bull Regime
  ema_trend_mb: [150]                  # Fixed (expand based on grid-search if needed)
  macd_fast_mb: [20]                   # Fixed
  macd_slow_mb: [50]                   # Fixed
  macd_signal_mb: [12]                 # Fixed

  # Bear Regime
  ema_trend_b: [100]                   # Fixed
  macd_fast_b: [12]                    # Fixed
  macd_slow_b: [26]                    # Fixed
  macd_signal_b: [9]                   # Fixed

  # ATR Calculation
  atr_period: [14]                     # Fixed

# Walk-Forward Settings
# ---------------------
# This section defines how WFO windows are calculated
# USER CONFIGURABLE: Adjust window sizes and date range
walk_forward:
  # Total date range for WFO
  # Must have sufficient market data for ALL symbols in database
  # TQQQ started: 2010-02-11
  # SQQQ started: 2010-02-11
  # VIX data: Available from 1990s
  # Recommendation: Start from 2010-03-01 to ensure data availability
  total_start_date: "2010-03-01"
  total_end_date: "2025-03-01"

  # Window size: IS + OOS combined
  # Example: 3.0 years = 2.5y IS + 0.5y OOS
  # USER CAN CHANGE: Smaller windows = more frequent re-optimization
  #                  Larger windows = more stable parameters
  window_size_years: 3.0

  # In-sample period (optimization/training)
  # Grid search runs on this period to find best parameters
  # USER CAN CHANGE: Larger IS = more data for optimization
  #                  Smaller IS = faster adaptation to regime changes
  in_sample_years: 2.5

  # Out-of-sample period (testing/validation)
  # Backtest runs with best params on this unseen data
  # USER CAN CHANGE: Larger OOS = more robust validation
  #                  Smaller OOS = more frequent re-optimization
  out_of_sample_years: 0.5

  # Slide amount (how far to move window forward)
  # Typically equals OOS period for non-overlapping OOS segments
  # USER CAN CHANGE: Smaller slide = overlapping windows (more data points)
  #                  Larger slide = independent windows (less correlation)
  slide_years: 0.5

  # Selection metric for choosing best parameters
  # Options: sharpe_ratio, sortino_ratio, calmar_ratio, total_return, annualized_return
  # USER CAN CHANGE: Different metrics may select different parameters
  # Recommendation: sortino_ratio (focuses on downside risk)
  selection_metric: "sortino_ratio"

# Expected Output
# ---------------
# output/wfo_Hierarchical_Adaptive_v1_YYYYMMDD_HHMMSS/
# ├── wfo_trades_master.csv      # All OOS trades (stitched chronologically)
# ├── wfo_parameter_log.csv      # Best parameters selected per window
# ├── wfo_equity_curve.csv       # Trade-by-trade equity progression
# ├── wfo_summary.txt            # Performance metrics and parameter stability
# ├── wfo_config.yaml            # Copy of this config
# └── window_001/                # First window results
#     ├── is_grid_search/        # Grid search results (IS period)
#     │   ├── summary_comparison.csv
#     │   └── run_config.csv
#     └── oos_backtest/          # Backtest results (OOS period)
#         ├── trades.csv
#         ├── portfolio_daily.csv
#         └── summary.csv
# └── window_002/                # Second window results
#     └── ... (same structure)
# └── ... (~27 more windows)

# WFO Window Plan (with above settings)
# --------------------------------------
# Total combinations per window: 256
# Total windows: ~29 (sliding from 2010 to 2025)
# Total backtests: 29 * 256 = 7,424
# Estimated runtime: 6-10 hours (depending on hardware)
#
# Window 1:  IS 2010-03-01 to 2012-09-01 → OOS 2012-09-01 to 2013-03-01
# Window 2:  IS 2010-09-01 to 2013-03-01 → OOS 2013-03-01 to 2013-09-01
# Window 3:  IS 2011-03-01 to 2013-09-01 → OOS 2013-09-01 to 2014-03-01
# ...
# Window 29: IS 2022-03-01 to 2024-09-01 → OOS 2024-09-01 to 2025-03-01

# Usage
# -----
# # Preview window plan (no execution)
# jutsu wfo --config grid-configs/examples/wfo_hierarchical_adaptive_v1.yaml --dry-run
#
# # Run full WFO
# jutsu wfo --config grid-configs/examples/wfo_hierarchical_adaptive_v1.yaml
#
# # Custom output directory
# jutsu wfo --config grid-configs/examples/wfo_hierarchical_adaptive_v1.yaml --output-dir results/wfo_test

# Analysis Workflow
# -----------------
# After WFO completes:
#
# 1. Review Equity Curve (wfo_equity_curve.csv)
#    - Consistent growth across all OOS periods = robust strategy
#    - Large drops in specific periods = regime sensitivity
#    - Compare to QQQ buy-and-hold baseline
#    - Compare to Kalman_MACD_Adaptive_v1 baseline (without VIX filter)
#
# 2. Check Parameter Stability (wfo_parameter_log.csv)
#    - Calculate coefficient of variation (CV%) for each parameter
#    - Low CV% (<30%) = stable, robust parameters
#    - High CV% (>50%) = parameters jump randomly = overfitting
#    - Look for temporal patterns (e.g., tighter stops in volatile periods)
#    - VIX EMA period stability: Does it stay constant or adapt to market conditions?
#
# 3. Analyze OOS Performance (wfo_summary.txt)
#    - Compare OOS Sharpe to IS Sharpe (should be close)
#    - Large gap = overfitting in grid search
#    - Check max drawdown and recovery across all OOS periods
#    - VIX filter effectiveness: Does it reduce drawdown in volatile OOS periods?
#
# 4. Parameter Trends
#    - Plot parameter values over time (from wfo_parameter_log.csv)
#    - Do certain values consistently appear? (e.g., always uses vix_ema_period=20)
#    - Are there market-condition patterns? (e.g., higher risk in bull markets)
#    - VIX-Kalman interaction: Do certain combinations appear together?
#
# 5. Regime Analysis
#    - Extract regime distribution from trades (STRONG_BULL, MODERATE_BULL, etc.)
#    - Does the strategy adapt correctly to market conditions?
#    - Are certain regimes more profitable than others?
#    - VIX filter behavior: Does it trigger more in bear markets (2020, 2022)?
#
# 6. VIX Filter Effectiveness (NEW)
#    - Calculate VIX filter trigger frequency per window
#    - Compare drawdowns in OOS windows with high VIX vs low VIX
#    - Verify VIX filter protects in volatile periods (Mar 2020)
#    - Check opportunity cost: Are VIX triggers reducing returns in stable markets?
#
# 7. Validation Criteria
#    ✅ PASS: OOS performance good AND parameters stable → Strategy is robust
#    ❌ FAIL: OOS performance poor OR parameters unstable → Strategy is overfit
#    ⚠️  REVIEW: Mixed results → Need deeper analysis or parameter adjustment

# Research Suggestions
# --------------------
# PROGRESSIVE WFO APPROACH:
#
# Step 1: Run this WFO config (VIX + Kalman + Thresholds focus)
# - Validates core VIX filter + regime classification is robust across time
# - Identifies stable VIX filter settings across different market conditions
# - Finds optimal VIX-Kalman interaction patterns
# - Tests threshold spacing robustness over 15-year period
#
# Step 2: Analyze parameter stability
# - If VIX params stable → VIX filter is robust, proceed
# - If Kalman params stable → Fix at most common values
# - If thresholds stable → Fix at most common values
# - If parameters unstable → Strategy may not be robust (revisit design)
#
# Step 3: Analyze VIX Filter Behavior
# - VIX filter trigger frequency: Should be <30% of trading days
# - VIX filter timing: Should trigger in volatile periods (2020 COVID, 2022 bear)
# - VIX filter effectiveness: Should reduce drawdown by 30-50% in volatile OOS windows
# - Opportunity cost: Performance in low-VIX periods should match baseline
#
# Step 4: Compare to Baselines
# - Hierarchical vs Kalman_MACD_Adaptive_v1 (without VIX filter)
# - Hierarchical vs buy-and-hold QQQ/TQQQ
# - VIX filter value-add: Improvement in risk-adjusted returns
#
# Step 5: Run regime-specific WFO (if Step 1 passes)
# - Create separate WFO configs for each regime's params
# - Use stable VIX/Kalman/threshold values from Step 1
# - Optimize Strong Bull EMA/MACD independently
# - Optimize Moderate Bull EMA/MACD independently
# - Optimize Bear EMA/MACD independently
#
# Step 6: Final validation WFO
# - Use best stable parameters from all previous steps
# - Run on fresh OOS period (2025 data when available)
# - Compare to buy-and-hold and other benchmarks
# - Validate VIX filter continues to add value

# CAUTIONARY NOTES:
# - WFO is computationally expensive (7,424 backtests)
# - Start with focused grid-search first to validate strategy concept
# - Only run WFO after grid-search shows promising results
# - If grid-search shows poor performance, WFO won't help
# - WFO reveals overfitting, it doesn't fix poor strategy design
# - VIX filter should show consistent benefit across multiple OOS windows

# VIX Filter Validation Criteria (NEW)
# -------------------------------------
# CRITICAL SUCCESS METRICS for VIX Filter:
#
# 1. Drawdown Protection (Primary Goal):
#    - 2020 COVID crash OOS window: Max drawdown should be 30-50% better than baseline
#    - 2022 bear market OOS window: Max drawdown should be 20-30% better than baseline
#    - Overall: Average OOS max drawdown should be <20% (vs <25% for baseline)
#
# 2. Trigger Behavior:
#    - Trigger frequency: 15-30% of trading days (allows >70% invested)
#    - Trigger timing: Concentrated in high-volatility periods (VIX > 25)
#    - False triggers: <10% of triggers in stable markets (VIX < 20)
#
# 3. Risk-Adjusted Returns:
#    - OOS Sharpe Ratio: 10-30% improvement vs Kalman_MACD baseline
#    - OOS Sortino Ratio: 15-35% improvement (downside protection focus)
#    - OOS Calmar Ratio: 20-40% improvement (drawdown focus)
#
# 4. Parameter Stability:
#    - VIX EMA period CV: <30% (stable across windows)
#    - VIX-Kalman correlation: Consistent interaction patterns
#    - Adaptive behavior: May see longer VIX EMAs in volatile periods
#
# 5. Opportunity Cost:
#    - Performance in low-VIX OOS windows: Should match baseline ±5%
#    - Time in market: >70% across all OOS windows
#    - Miss rate: <15% of profitable regime opportunities due to VIX filter
#
# FAILURE SIGNALS:
# ❌ VIX filter triggers >40% of time (over-conservative)
# ❌ VIX filter fails to protect in 2020 COVID crash (<20% drawdown improvement)
# ❌ VIX filter degrades performance in stable markets (>10% underperformance)
# ❌ VIX EMA period CV >50% (unstable, random parameter selection)
# ❌ OOS Sharpe degradation vs baseline (VIX filter hurting, not helping)

# Success Pathway
# ---------------
# ✅ IDEAL OUTCOME:
# - VIX filter reduces average OOS drawdown by 30-40%
# - VIX filter improves OOS Sharpe by 15-25%
# - VIX EMA period stable (CV <25%)
# - Trigger frequency 20-25% (balanced protection vs opportunity)
# - Performance in stable markets matches baseline ±3%
# → PROCEED to production testing with confidence
#
# ⚠️  ACCEPTABLE OUTCOME:
# - VIX filter reduces average OOS drawdown by 15-25%
# - VIX filter improves OOS Sharpe by 5-15%
# - VIX EMA period moderately stable (CV 25-40%)
# - Trigger frequency 15-30% (acceptable range)
# - Performance in stable markets ±5% of baseline
# → CONSIDER refinements, may proceed with caution
#
# ❌ UNACCEPTABLE OUTCOME:
# - VIX filter fails to reduce OOS drawdown (<10% improvement)
# - VIX filter degrades OOS Sharpe vs baseline
# - VIX EMA period unstable (CV >50%)
# - Trigger frequency <10% or >40% (ineffective or over-conservative)
# - Significant underperformance in stable markets (>10%)
# → REVISIT VIX filter design, consider alternative volatility metrics
