# Grid Search Configuration for Kalman-MACD Adaptive v1
# ========================================================
# Hierarchical "strategy-of-strategies" using Kalman filter for regime classification.
#
# Strategy Overview:
# - Master Filter: Kalman Filter Trend Strength Oscillator (-100 to +100)
# - 4 Regimes: Strong Bull, Moderate Bull, Chop/Neutral, Bear
# - 4 Trading Vehicles: TQQQ (3x long), QQQ (1x), SQQQ (3x inverse), CASH
# - Regime-Specific Logic: Each regime has different EMA/MACD parameters and vehicle selection
#
# Parameter Categories:
# 1. Kalman Filter: measurement_noise, osc_smoothness, strength_smoothness
# 2. Regime Thresholds: thresh_strong_bull, thresh_moderate_bull, thresh_moderate_bear
# 3. Risk Management: atr_stop_multiplier, risk_leveraged, allocation_unleveraged
# 4. Regime-Specific Parameters: EMA/MACD params for each regime (fixed at defaults initially)
#
# Total combinations (initial): 3 * 3 * 3 * 2 * 2 * 2 * 3 * 2 = 1,296
# Estimated runtime: 45-90 minutes (depending on hardware)

# Strategy to optimize
strategy: "Kalman_MACD_Adaptive_v1"

# Symbol Sets
# -----------
# This strategy requires 3 symbols for regime-based trading:
# - signal_symbol (QQQ): Used for Kalman filter, EMA, and MACD calculations
# - bull_symbol (TQQQ): 3x leveraged long for STRONG_BULL regime
# - bear_symbol (SQQQ): 3x inverse for BEAR regime
# - defense_symbol (QQQ): 1x for MODERATE_BULL regime
symbol_sets:
  - name: "QQQ_TQQQ_SQQQ"
    signal_symbol: "QQQ"      # Kalman filter calculations
    bull_symbol: "TQQQ"       # 3x leveraged long for aggressive regime
    defense_symbol: "QQQ"     # 1x for moderate regime
    bear_symbol: "SQQQ"       # 3x inverse for bear regime
    vix_symbol: null          # Not used in this strategy

# Base Configuration
# ------------------
# Fixed settings applied to ALL backtests
# USER CONFIGURABLE: Change date range for different market conditions
base_config:
  # Date range - Default: Full history (2010-2024)
  # Includes: Financial crisis recovery, bull market, COVID crash, recovery
  # USER CAN CHANGE: Try "2020-01-01" to "2024-12-31" for recent market focus
  start_date: "2010-03-01"
  end_date: "2025-11-01"

  # Market data
  timeframe: "1D"

  # Portfolio settings
  initial_capital: 100000  # Matches strategy spec ($100,000)
  commission: 0.0          # Strategy spec: $0.00 per trade
  slippage: 0.0005         # Strategy spec: 0.05% per trade

# Parameters to Optimize
# ----------------------
# USER CONFIGURABLE: Expand/reduce any parameter range based on your research
# Grid search will test ALL combinations of these parameters

parameters:
  # ============================================================================
  # TIER 1: KALMAN FILTER PARAMETERS (Master Regime Filter)
  # ============================================================================
  # These control the Kalman filter's smoothness and regime classification
  # Higher values = smoother, slower-moving trend strength
  # Lower values = more responsive, noisier trend strength

  # Measurement noise (higher = smoother Kalman filter)
  # Strategy doc suggests: [2000.0, 5000.0, 10000.0]
  # Starting focused: [2000.0, 5000.0] for faster iteration
  # USER CAN EXPAND: Add 10000.0 or try [1000, 2000, 5000, 10000]
  measurement_noise: [2000.0, 5000.0, 10000]

  # Oscillator smoothness (higher = smoother oscillator)
  # Strategy doc suggests: [15, 20, 30]
  # Starting focused: [15, 20]
  # USER CAN EXPAND: Add 30 or try [10, 15, 20, 30]
  osc_smoothness: [15, 20]

  # Strength smoothness (higher = smoother trend strength)
  # Strategy doc suggests: [15, 20, 30]
  # Starting focused: [15, 20]
  # USER CAN EXPAND: Add 30 or try [10, 15, 20, 30]
  strength_smoothness: [15, 20, 30]

  # ============================================================================
  # TIER 2: REGIME THRESHOLD PARAMETERS (Critical for Regime Switching)
  # ============================================================================
  # These define the boundaries between market regimes
  # STRONG_BULL: trend_strength > thresh_strong_bull
  # MODERATE_BULL: thresh_moderate_bull < trend_strength <= thresh_strong_bull
  # CHOP/NEUTRAL: thresh_moderate_bear <= trend_strength <= thresh_moderate_bull
  # BEAR: trend_strength < thresh_moderate_bear

  # Strong Bull threshold (entry point for aggressive 3x leverage)
  # Strategy doc suggests: [60, 70, 80]
  # Higher values = more conservative (requires stronger trend for TQQQ)
  # USER CAN EXPAND: Try [50, 60, 70, 80, 90] for wider exploration
  thresh_strong_bull: [60]

  # Moderate Bull threshold (entry point for 1x QQQ positions)
  # Strategy doc suggests: [15, 20, 30]
  # Higher values = more conservative (requires stronger trend for QQQ)
  # USER CAN EXPAND: Try [10, 15, 20, 30, 40]
  thresh_moderate_bull: [20]

  # Moderate Bear threshold (entry point for defensive SQQQ)
  # Strategy doc suggests: [-15, -20, -30]
  # More negative = more conservative (requires stronger downtrend for SQQQ)
  # USER CAN EXPAND: Try [-10, -15, -20, -30, -40]
  thresh_moderate_bear: [-20]

  # ============================================================================
  # TIER 3: RISK MANAGEMENT PARAMETERS
  # ============================================================================
  # Control position sizing and stop-loss behavior for leveraged positions

  # ATR stop-loss multiplier (for TQQQ/SQQQ positions only)
  # Strategy doc suggests: [2.0, 2.5, 3.0]
  # Higher values = wider stops (fewer stop-outs, larger losses when hit)
  # Lower values = tighter stops (more stop-outs, smaller losses)
  # USER CAN EXPAND: Try [1.5, 2.0, 2.5, 3.0, 3.5]
  atr_stop_multiplier: [2]

  # Risk per leveraged trade (TQQQ/SQQQ only)
  # Strategy doc suggests: [0.015, 0.02, 0.025] (1.5%, 2%, 2.5%)
  # Starting focused: [0.02, 0.025] for faster iteration
  # Higher values = larger positions (more risk, more reward)
  # USER CAN EXPAND: Add 0.015 or try [0.01, 0.015, 0.02, 0.025, 0.03]
  risk_leveraged: [0.025]

  # Allocation for unleveraged positions (QQQ only)
  # Strategy doc suggests: [0.6, 0.8, 1.0] (60%, 80%, 100%)
  # Starting fixed: [0.8] for focused optimization
  # Higher values = larger QQQ positions in moderate bull regime
  # USER CAN EXPAND: Try [0.6, 0.8, 1.0] for allocation sweep
  allocation_unleveraged: [0.8]

  # ============================================================================
  # TIER 4: REGIME-SPECIFIC PARAMETERS (Fixed at defaults initially)
  # ============================================================================
  # Each regime has its own EMA trend filter and MACD parameters
  # These are FIXED at strategy document defaults for initial optimization
  # USER CAN OPTIMIZE: After finding good Kalman/threshold params, run focused
  # grid searches on each regime's params separately

  # --- STRONG BULL REGIME PARAMETERS ---
  # Used when trend_strength > thresh_strong_bull
  # Targets: TQQQ (aggressive) or QQQ (conservative) or CASH
  ema_trend_sb: [100, 75]           # Strategy doc default, USER CAN EXPAND: [75, 100, 125]
  macd_fast_sb: [12]            # Strategy doc default, USER CAN EXPAND: [12, 20]
  macd_slow_sb: [26]            # Strategy doc default, USER CAN EXPAND: [26, 50]
  macd_signal_sb: [9]           # Strategy doc default, USER CAN EXPAND: [9]

  # --- MODERATE BULL REGIME PARAMETERS ---
  # Used when thresh_moderate_bull < trend_strength <= thresh_strong_bull
  # Targets: QQQ (cautious) or CASH
  ema_trend_mb: [150, 100]           # Strategy doc default, USER CAN EXPAND: [100, 150, 200]
  macd_fast_mb: [20]            # Strategy doc default, USER CAN EXPAND: [12, 20]
  macd_slow_mb: [50]            # Strategy doc default, USER CAN EXPAND: [26, 50]
  macd_signal_mb: [12]          # Strategy doc default, USER CAN EXPAND: [9, 12]

  # --- BEAR REGIME PARAMETERS ---
  # Used when trend_strength < thresh_moderate_bear
  # Targets: SQQQ (inverse) or CASH
  ema_trend_b: [100, 75]            # Strategy doc default, USER CAN EXPAND: [75, 100, 125]
  macd_fast_b: [12]             # Strategy doc default, USER CAN EXPAND: [12, 20]
  macd_slow_b: [26]             # Strategy doc default, USER CAN EXPAND: [26, 50]
  macd_signal_b: [9]            # Strategy doc default, USER CAN EXPAND: [9]

  # --- ATR CALCULATION (Fixed) ---
  # Used for stop-loss calculations on TQQQ/SQQQ
  atr_period: [14]              # Strategy doc default (standard ATR period)

# Optional Constraints
# --------------------
# Safety limits to prevent accidental large-scale runs

# Maximum total combinations to run
# Current combinations: 1,296
# USER CAN INCREASE: If you expand parameter ranges above
max_combinations: 20000

# Checkpoint interval
# Save progress every N backtests for resume capability
checkpoint_interval: 50

# Expected Output
# ---------------
# output/grid_search_Kalman_MACD_Adaptive_v1_YYYYMMDD_HHMMSS/
# ├── summary_comparison.csv   # Metrics for all 1,296 runs (sortable)
# ├── run_config.csv          # Parameter mapping (which run = which params)
# ├── parameters.yaml         # Copy of this config file
# ├── README.txt             # Summary statistics and top performers
# ├── run_001/               # First parameter combination
# │   ├── portfolio_daily.csv
# │   ├── trades.csv
# │   └── summary.csv
# ├── run_002/               # Second parameter combination
# │   ├── portfolio_daily.csv
# │   ├── trades.csv
# │   └── summary.csv
# └── ... (1,294 more runs)

# Usage
# -----
# jutsu grid-search --config grid-configs/examples/grid_search_kalman_macd_adaptive_v1.yaml
#
# After completion:
# 1. Open summary_comparison.csv
# 2. Sort by Sharpe Ratio (highest to lowest)
# 3. Review top 10-20 parameter combinations
# 4. Look for consistent patterns:
#    - Do certain Kalman filter settings consistently outperform?
#    - What threshold spacing works best (tight vs wide)?
#    - Are tighter or wider stops better for leveraged positions?
#    - Does higher risk allocation improve returns or increase drawdown?
# 5. Identify parameter stability:
#    - Do top performers cluster around specific values?
#    - Or do parameters vary widely (sign of overfitting)?
# 6. Next steps:
#    - Run focused grid search on promising parameter ranges
#    - Optimize regime-specific parameters (EMA/MACD) separately
#    - Run WFO to validate robustness across time periods

# Research Suggestions
# --------------------
# STAGED OPTIMIZATION APPROACH (recommended):
#
# Stage 1: Optimize Kalman + Thresholds (this config)
# - Find best measurement_noise, osc_smoothness, strength_smoothness
# - Find optimal threshold spacing (tight vs wide regime boundaries)
# - Keep regime params at defaults
#
# Stage 2: Optimize Strong Bull Regime
# - Fix Kalman/thresholds at Stage 1 winners
# - Expand ema_trend_sb: [75, 100, 125]
# - Expand MACD params: fast [12, 20], slow [26, 50]
# - Find best aggressive parameters
#
# Stage 3: Optimize Moderate Bull Regime
# - Fix Kalman/thresholds at Stage 1 winners
# - Expand ema_trend_mb: [100, 150, 200]
# - Expand MACD params: fast [12, 20], slow [26, 50], signal [9, 12]
# - Find best cautious parameters
#
# Stage 4: Optimize Bear Regime
# - Fix Kalman/thresholds at Stage 1 winners
# - Expand ema_trend_b: [75, 100, 125]
# - Expand MACD params: fast [12, 20], slow [26, 50]
# - Find best defensive/short parameters
#
# Stage 5: Full WFO Validation
# - Use best parameters from Stages 1-4
# - Run walk-forward optimization to validate robustness
# - Check parameter stability across time periods
