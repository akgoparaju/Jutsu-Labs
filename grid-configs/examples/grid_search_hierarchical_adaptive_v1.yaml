# Grid Search Configuration for Hierarchical Adaptive v1.0 (FULL)
# ========================================================
# Comprehensive grid search with full parameter exploration (3,888 runs)
# for robust optimization of Hierarchical Adaptive v1.0 strategy.
#
# Strategy Overview:
# - TIER 0: VIX Volatility Filter (master switch) - NEW
# - TIER 1: Kalman Filter Trend Strength Oscillator (-100 to +100)
# - TIER 2: 4 Regimes: Strong Bull, Moderate Bull, Chop/Neutral, Bear
# - TIER 3: 4 Trading Vehicles: TQQQ (3x long), QQQ (1x), SQQQ (3x inverse), CASH
# - TIER 4: Regime-Specific Logic: Each regime has different EMA/MACD parameters
#
# Full Parameter Strategy:
# - Test 3 VIX EMA periods: [20, 50, 75] - NEW
# - Test 3 Kalman measurement_noise values: [2000.0, 5000.0, 10000.0]
# - Test 3 osc_smoothness values: [15, 20, 30]
# - Test 3 strength_smoothness values: [15, 20, 30]
# - Test 2 regime threshold combinations
# - Test 2 ATR stop multipliers: [2.0, 2.5]
# - Test 3 risk_leveraged values: [0.015, 0.02, 0.025]
# - Test 2 allocation_unleveraged values: [0.8, 1.0]
# - Test 2 regime parameter sets (Strong Bull and Moderate Bull)
#
# Total combinations: 3 * 3 * 3 * 3 * 2 * 2 * 3 * 2 * 2 * 2 = 3,888 runs
# Estimated runtime: 90-180 minutes (depending on hardware)
#
# Purpose: Comprehensive parameter optimization after focused test validation

# Strategy to optimize
strategy: "Hierarchical_Adaptive_v1"

# Symbol Sets
# -----------
# This strategy requires 4 symbols (VIX added vs Kalman_MACD_Adaptive_v1):
symbol_sets:
  - name: "QQQ_TQQQ_SQQQ_VIX"
    signal_symbol: "QQQ"      # Kalman filter calculations
    bull_symbol: "TQQQ"       # 3x leveraged long for aggressive regime
    defense_symbol: "QQQ"     # 1x for moderate regime
    bear_symbol: "SQQQ"       # 3x inverse for bear regime
    vix_symbol: "VIX"         # Volatility filter (master switch) - NEW

# Base Configuration
# ------------------
# Fixed settings applied to ALL backtests
base_config:
  # Date range - Default: Full history (2010-2024)
  # Includes: Financial crisis recovery, bull market, COVID crash, recovery
  start_date: "2010-03-01"
  end_date: "2025-11-01"

  # Market data
  timeframe: "1D"

  # Portfolio settings
  initial_capital: 100000  # Matches strategy spec ($100,000)
  commission: 0.0          # Strategy spec: $0.00 per trade
  slippage: 0.0005         # Strategy spec: 0.05% per trade

# Parameters to Optimize
# ----------------------
# FULL PARAMETER SET: Comprehensive exploration of parameter space
# Based on strategy spec suggestions and focused test results
#
# Total combinations: 3,888
# Estimated runtime: 90-180 minutes

parameters:
  # ============================================================================
  # TIER 0: VIX VOLATILITY FILTER (Master Risk Switch) - NEW
  # ============================================================================
  # VIX EMA period controls volatility filter sensitivity
  # - 20: Fast-reacting (strategy spec default, from MACD_Trend-v6)
  # - 50: Medium-reacting (balance between responsiveness and stability)
  # - 75: Slow-reacting (strategy spec suggestion for robustness test)
  # Higher values = fewer VIX triggers, more time invested, higher drawdown risk
  # Lower values = more VIX triggers, more time in CASH, lower returns but safer

  vix_ema_period: [50, 75, 100]  # NEW PARAMETER (3 values)

  # ============================================================================
  # TIER 1: KALMAN FILTER PARAMETERS (Master Regime Filter)
  # ============================================================================
  # These control the Kalman filter's smoothness and regime classification
  # Higher values = smoother, slower-moving trend strength
  # Lower values = more responsive, noisier trend strength

  # Measurement noise (higher = smoother Kalman filter)
  # Strategy doc suggests: [2000.0, 5000.0, 10000.0]
  # Full exploration: Test all 3 values
  measurement_noise: [2000.0, 1000.0]  # 3 values

  # Oscillator smoothness (higher = smoother oscillator)
  # Strategy doc suggests: [15, 20, 30]
  # Full exploration: Test all 3 values
  osc_smoothness: [15]  # 3 values

  # Strength smoothness (higher = smoother trend strength)
  # Strategy doc suggests: [15, 20, 30]
  # Full exploration: Test all 3 values
  strength_smoothness: [15]  # 3 values

  # Process noise parameters (fixed at defaults)
  # These are internal Kalman filter tuning parameters
  # Not recommended for optimization unless Kalman expert
  process_noise_1: [0.01]  # Fixed
  process_noise_2: [0.01]  # Fixed

  # ============================================================================
  # TIER 2: REGIME THRESHOLD PARAMETERS (Critical for Regime Switching)
  # ============================================================================
  # These define the boundaries between market regimes
  # STRONG_BULL: trend_strength > thresh_strong_bull
  # MODERATE_BULL: thresh_moderate_bull < trend_strength <= thresh_strong_bull
  # CHOP/NEUTRAL: thresh_moderate_bear <= trend_strength <= thresh_moderate_bull
  # BEAR: trend_strength < thresh_moderate_bear

  # Strong Bull threshold (entry point for aggressive 3x leverage)
  # Strategy doc suggests: [60, 70, 80]
  # Starting with 2 values: [60, 70]
  # Higher values = more conservative (requires stronger trend for TQQQ)
  thresh_strong_bull: [60, 70]  # 2 values

  # Moderate Bull threshold (entry point for 1x QQQ positions)
  # Strategy doc suggests: [15, 20, 30]
  # Fixed at default for full grid (optimize separately if needed)
  thresh_moderate_bull: [10, 15]  # Fixed

  # Moderate Bear threshold (entry point for defensive SQQQ)
  # Strategy doc suggests: [-15, -20, -30]
  # Fixed at default for full grid (optimize separately if needed)
  thresh_moderate_bear: [-10, -15]  # Fixed

  # ============================================================================
  # TIER 3: RISK MANAGEMENT PARAMETERS
  # ============================================================================
  # Control position sizing and stop-loss behavior for leveraged positions

  # ATR stop-loss multiplier (for TQQQ/SQQQ positions only)
  # Strategy doc suggests: [2.0, 2.5, 3.0]
  # Starting with 2 values: [2.0, 2.5]
  # Higher values = wider stops (fewer stop-outs, larger losses when hit)
  # Lower values = tighter stops (more stop-outs, smaller losses)
  atr_stop_multiplier: [2.0, 2.5]  # 2 values

  # Risk per leveraged trade (TQQQ/SQQQ only)
  # Strategy doc suggests: [0.015, 0.02, 0.025] (1.5%, 2%, 2.5%)
  # Full exploration: Test all 3 values
  # Higher values = larger positions (more risk, more reward)
  # risk_leveraged: [0.015, 0.02, 0.025]  # 3 values
  risk_leveraged: [0.02, 0.025]  # 3 values

  # Allocation for unleveraged positions (QQQ only)
  # Strategy doc suggests: [0.6, 0.8, 1.0] (60%, 80%, 100%)
  # Starting with 2 values: [0.8, 1.0]
  # Higher values = larger QQQ positions in moderate bull regime
  allocation_unleveraged: [1.0]  # 2 values

  # ============================================================================
  # TIER 4: REGIME-SPECIFIC PARAMETERS (Partial Exploration)
  # ============================================================================
  # Each regime has its own EMA trend filter and MACD parameters
  # Full optimization would require separate grid searches per regime
  # Here we test 2 promising configurations based on strategy spec

  # --- STRONG BULL REGIME PARAMETERS ---
  # Used when trend_strength > thresh_strong_bull
  # Targets: TQQQ (aggressive) or QQQ (conservative) or CASH
  # Strategy doc suggests: ema_trend_sb [75, 100, 125]
  # Test 2 values: [75, 100]
  ema_trend_sb: [100]       # 2 values

  # MACD parameters for Strong Bull (fixed at defaults)
  # Can optimize separately after finding good Kalman/threshold params
  macd_fast_sb: [12]            # Fixed
  macd_slow_sb: [26]            # Fixed
  macd_signal_sb: [9]           # Fixed

  # --- MODERATE BULL REGIME PARAMETERS ---
  # Used when thresh_moderate_bull < trend_strength <= thresh_strong_bull
  # Targets: QQQ (cautious) or CASH
  # Strategy doc suggests: ema_trend_mb [100, 150, 200]
  # Test 2 values: [100, 150]
  ema_trend_mb: [150]      # 2 values

  # MACD parameters for Moderate Bull (fixed at defaults)
  macd_fast_mb: [20]            # Fixed
  macd_slow_mb: [50]            # Fixed
  macd_signal_mb: [12]          # Fixed

  # --- BEAR REGIME PARAMETERS ---
  # Used when trend_strength < thresh_moderate_bear
  # Targets: SQQQ (inverse) or CASH
  # Strategy doc suggests: ema_trend_b [75, 100, 125]
  # Fixed at default for full grid (optimize separately if needed)
  ema_trend_b: [100]            # Fixed

  # MACD parameters for Bear (fixed at defaults)
  macd_fast_b: [12]             # Fixed
  macd_slow_b: [26]             # Fixed
  macd_signal_b: [9]            # Fixed

  # --- ATR CALCULATION (Fixed) ---
  # Used for stop-loss calculations on TQQQ/SQQQ
  atr_period: [14]              # Fixed (standard ATR period)

# Optional Constraints
# --------------------
# Safety limits to prevent accidental large-scale runs

# Maximum total combinations to run
# Current combinations: 3,888
max_combinations: 5000

# Checkpoint interval
# Save progress every N backtests for resume capability
checkpoint_interval: 100

# Expected Output
# ---------------
# output/grid_search_Hierarchical_Adaptive_v1_YYYYMMDD_HHMMSS/
# ├── summary_comparison.csv   # Metrics for all 3,888 runs (sortable)
# ├── run_config.csv          # Parameter mapping (which run = which params)
# ├── parameters.yaml         # Copy of this config file
# ├── README.txt             # Summary statistics and top performers
# ├── run_0001/              # First parameter combination
# │   ├── portfolio_daily.csv
# │   ├── trades.csv
# │   └── summary.csv
# ├── run_0002/              # Second parameter combination
# │   ├── portfolio_daily.csv
# │   ├── trades.csv
# │   └── summary.csv
# └── ... (3,886 more runs)

# Usage
# -----
# jutsu grid-search --config grid-configs/examples/grid_search_hierarchical_adaptive_v1.yaml
#
# After completion:
# 1. Open summary_comparison.csv
# 2. Sort by Sharpe Ratio (highest to lowest)
# 3. Review top 20-50 parameter combinations
# 4. Look for consistent patterns:
#    - Do certain VIX EMA periods consistently outperform?
#    - What Kalman filter settings work best (measurement_noise, smoothness)?
#    - What threshold spacing works best (tight vs wide regime boundaries)?
#    - Are tighter or wider ATR stops better for leveraged positions?
#    - Does higher risk allocation improve returns or increase drawdown?
#    - Which regime-specific EMA values perform best?
# 5. Identify parameter stability:
#    - Do top performers cluster around specific values?
#    - Or do parameters vary widely (sign of overfitting)?
# 6. Compare to baselines:
#    - Hierarchical vs Kalman_MACD_Adaptive_v1 (without VIX filter)
#    - Hierarchical vs buy-and-hold QQQ/TQQQ
# 7. Next steps:
#    - Run focused grid search on promising parameter ranges (refine)
#    - Optimize regime-specific parameters (EMA/MACD) separately
#    - Run WFO to validate robustness across time periods

# Research Suggestions
# --------------------
# STAGED OPTIMIZATION APPROACH (recommended):
#
# Stage 1: Analyze VIX Filter Impact (already completed in focused test)
# - Validated VIX filter adds value over baseline
# - Identified best VIX EMA period range
#
# Stage 2: Optimize Kalman + Thresholds (this config)
# - Find best measurement_noise, osc_smoothness, strength_smoothness
# - Find optimal threshold spacing (tight vs wide regime boundaries)
# - Validate VIX-Kalman interaction across parameter combinations
# - Keep regime params at defaults
#
# Stage 3: Analyze Results and Refine (after this grid search)
# - Identify parameter clusters for top performers
# - Check for overfitting (wide parameter variation = bad)
# - Validate results make intuitive sense
# - Compare performance across market regimes (bull, bear, chop)
#
# Stage 4: Optimize Strong Bull Regime (separate focused grid)
# - Fix Kalman/VIX/thresholds at Stage 2 winners
# - Expand ema_trend_sb: [75, 100, 125]
# - Expand MACD params: fast [12, 20], slow [26, 50]
# - Find best aggressive parameters
#
# Stage 5: Optimize Moderate Bull Regime (separate focused grid)
# - Fix Kalman/VIX/thresholds at Stage 2 winners
# - Expand ema_trend_mb: [100, 150, 200]
# - Expand MACD params: fast [12, 20], slow [26, 50], signal [9, 12]
# - Find best cautious parameters
#
# Stage 6: Optimize Bear Regime (separate focused grid)
# - Fix Kalman/VIX/thresholds at Stage 2 winners
# - Expand ema_trend_b: [75, 100, 125]
# - Expand MACD params: fast [12, 20], slow [26, 50]
# - Find best defensive/short parameters
#
# Stage 7: Full WFO Validation (final step)
# - Use best parameters from Stages 1-6
# - Run walk-forward optimization to validate robustness
# - Check parameter stability across time periods
# - Validate performance in different market conditions

# Performance Expectations
# ------------------------
# Based on strategy spec and Kalman_MACD_Adaptive_v1 baseline:
#
# MINIMUM SUCCESS CRITERIA:
# - Sharpe Ratio: >1.5 (ideally >2.0 for top performers)
# - Max Drawdown: <25% (ideally <20% with VIX filter protection)
# - Win Rate: >50% (ideally >55%)
# - Calmar Ratio: >1.0 (ideally >1.5)
#
# VIX FILTER SPECIFIC CRITERIA:
# - VIX filter should reduce 2020 COVID drawdown by 30-50% vs no-filter
# - VIX filter should trigger in <30% of trading days (allow >70% invested)
# - Performance during low-VIX periods should match or beat baseline
# - Risk-adjusted returns should improve by 10-30% vs Kalman_MACD baseline
#
# REGIME PERFORMANCE EXPECTATIONS:
# - Strong Bull (TQQQ): High returns but controlled drawdown via VIX filter
# - Moderate Bull (QQQ): Steady returns, low drawdown, high time invested
# - Chop/Neutral (CASH): Minimal trades, capital preservation
# - Bear (SQQQ): Profitable in downtrends, limited whipsaw via regime filter

# Analysis Checklist
# -------------------
# After grid search completes:
#
# PARAMETER ANALYSIS:
# - [ ] Top 50 runs: Do VIX EMA periods cluster around specific values?
# - [ ] Top 50 runs: Do Kalman params (measurement_noise, smoothness) cluster?
# - [ ] Top 50 runs: What threshold combinations appear most often?
# - [ ] Top 50 runs: What risk management params (ATR, risk%, allocation)?
# - [ ] Parameter stability: Do results vary wildly or show clear winners?
#
# PERFORMANCE ANALYSIS:
# - [ ] Compare best Hierarchical vs best Kalman_MACD_Adaptive_v1
# - [ ] Analyze VIX filter behavior: trigger frequency, timing, effectiveness
# - [ ] Check performance during 2020 COVID crash (critical VIX filter test)
# - [ ] Verify regime transitions: smooth or excessive churn?
# - [ ] Review trade quality: win rate, avg win/loss, profit factor
#
# RISK ANALYSIS:
# - [ ] Max drawdown: Does VIX filter reduce drawdown as expected?
# - [ ] Drawdown recovery: How quickly does strategy recover from losses?
# - [ ] VIX-regime interaction: Does VIX override lead to missed opportunities?
# - [ ] Stop-loss effectiveness: Are ATR stops helping or hurting?
# - [ ] Position sizing: Is risk allocation appropriate for volatility?
#
# ROBUSTNESS CHECKS:
# - [ ] Performance across market regimes: bull (2010-2019), bear (2020, 2022), recovery (2021, 2023)
# - [ ] Consistency: Do top performers work well across entire period or just specific years?
# - [ ] Overfitting signs: Are top performers very close or widely separated in parameter space?
# - [ ] Baseline comparison: Does adding VIX filter justify added complexity?
#
# DECISION CRITERIA:
# ✅ PROCEED TO WFO: Top performers cluster, VIX filter adds value, robust across regimes
# ⚠️  INVESTIGATE: Mixed results, need deeper analysis or regime-specific optimization
# ❌ REVISIT DESIGN: Poor performance, VIX filter not helping, or excessive overfitting
