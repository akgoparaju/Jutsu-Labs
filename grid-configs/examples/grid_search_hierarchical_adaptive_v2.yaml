# Grid Search Configuration for Hierarchical Adaptive v2.0 (Phase 1)
# ========================================================================
# Phase 1 Focused Grid Search: 243 runs (3^5 parameter combinations)
# Validates core v2 paradigm: Continuous exposure overlay engine
#
# Strategy Overview (v2.0 Paradigm Shift):
# ----------------------------------------
# v1: Discrete 3-tier filter (VIX gate → Kalman regime → MACD entry) → Binary positions
# v2: Continuous 5-tier exposure overlay → E_t ∈ [0.5, 1.3] → QQQ/TQQQ mapping
#
# 5-Tier Exposure Engine:
# - TIER 1: Kalman trend → T_norm ∈ [-1, +1]
# - TIER 2: Baseline exposure → E_trend = 1.0 + k_trend * T_norm
# - TIER 3: Volatility modulator → S_vol = clip(σ_target / σ_real, S_min, S_max)
# - TIER 4: VIX compression → P_VIX = 1 / (1 + α_VIX * (R_VIX - 1))
# - TIER 5: Drawdown governor → P_DD (linear compression DD_soft → DD_hard)
#
# Position Mapping (v2.0 Long-Side Only):
# - If E_t ≤ 1.0: w_TQQQ = 0, w_QQQ = E_t, w_cash = 1 - E_t
# - If E_t > 1.0: w_TQQQ = (E_t - 1)/2, w_QQQ = 1 - w_TQQQ, w_cash = 0
#
# Phase 1 Strategy:
# -----------------
# Focus: 5 critical parameters controlling core trend/exposure dynamics
# - measurement_noise: Kalman filter smoothness
# - osc_smoothness: Kalman oscillator smoothing
# - strength_smoothness: Trend strength smoothing
# - T_max: Trend normalization threshold (CRITICAL)
# - k_trend: Baseline exposure slope (CRITICAL - controls E_trend sensitivity)
#
# All modulators (vol, VIX, DD) fixed at defaults for Phase 1
# Phase 2 will optimize modulators based on Phase 1 winners
#
# Total combinations: 3^5 = 243 runs
# Estimated runtime: 30-45 minutes (depending on hardware)

# Strategy to optimize
strategy: "Hierarchical_Adaptive_v2"

# Symbol Sets
# -----------
# v2.0 requires 3 symbols (vs v1's 4):
# - No SQQQ in v2.0 (long-side only)
# - VIX still used for compression modulator
symbol_sets:
  - name: "QQQ_TQQQ_VIX"
    signal_symbol: "QQQ"           # Kalman filter calculations
    core_long_symbol: "QQQ"        # 1x base allocation
    leveraged_long_symbol: "TQQQ"  # 3x leveraged overlay (when E_t > 1.0)
    vix_symbol: "VIX"              # Volatility compression modulator

# Base Configuration
# ------------------
# Fixed settings applied to ALL backtests
base_config:
  # Date range - Full history (2010-2024)
  # Includes: Financial crisis recovery, bull market, COVID crash, recovery
  start_date: "2010-03-01"
  end_date: "2025-11-01"

  # Market data
  timeframe: "1D"

  # Portfolio settings
  initial_capital: 10000  # $100,000 starting capital
  commission: 0.0          # $0.00 per trade
  slippage: 0.0005         # 0.05% per trade

# Parameters to Optimize
# ----------------------
# Phase 1: 5 critical parameters (3 values each = 243 combinations)
# All other parameters fixed at defaults from hierarchical_adaptive_v2.md Section 10.6

parameters:
  # ===========================================================================
  # TIER 1: KALMAN FILTER PARAMETERS (3 parameters optimized)
  # ===========================================================================
  # Controls trend calculation and normalization

  # Measurement noise (higher = smoother Kalman filter)
  # Default: 2000.0, Range: [1000.0, 5000.0]
  # Lower values = more responsive, noisier trend
  # Higher values = smoother, slower-moving trend
  measurement_noise: [1000.0, 2000.0, 3000.0]  # 3 values

  # Oscillator smoothness (higher = smoother oscillator)
  # Default: 15, Range: [10, 20]
  # Controls smoothing of trend oscillator component
  osc_smoothness: [15]  # 3 values

  # Strength smoothness (higher = smoother trend strength)
  # Default: 15, Range: [10, 20]
  # Controls smoothing of trend strength signal
  strength_smoothness: [15]  # 3 values

  # Process noise parameters (fixed at defaults)
  process_noise_1: [0.01]  # Fixed
  process_noise_2: [0.01]  # Fixed

  # ===========================================================================
  # TIER 2: BASELINE EXPOSURE PARAMETERS (2 parameters optimized)
  # ===========================================================================
  # Controls E_trend = 1.0 + k_trend * T_norm

  # Trend normalization max (CRITICAL parameter)
  # Default: 60, Range: [50, 70]
  # T_norm = clip(trend_strength / T_max, -1, +1)
  # Lower values = stronger trends hit ±1 faster (more aggressive)
  # Higher values = trends stay in mid-range longer (more conservative)
  T_max: [60]  # 3 values

  # Baseline exposure slope (CRITICAL parameter)
  # Default: 0.3, Range: [0.2, 0.4]
  # E_trend = 1.0 + k_trend * T_norm
  # Lower values = less exposure variation (more stable)
  # Higher values = more exposure variation (more aggressive)
  k_trend: [0.3, 0.5, 0.7]  # 3 values

  # Exposure bounds (fixed at defaults for Phase 1)
  E_min: [0.4]   # Fixed: Minimum exposure (50% QQQ in weakest trend)
  E_max: [1.5]   # Fixed: Maximum exposure (1.3x leverage cap)

  # ===========================================================================
  # TIER 3: VOLATILITY MODULATOR (Fixed at defaults for Phase 1)
  # ===========================================================================
  # Will optimize in Phase 2 based on Phase 1 winners

  sigma_target_multiplier: [0.7,0.8,0.9]  # Fixed: σ_target = historical_vol × 0.9
  realized_vol_lookback: [20]     # Fixed: 20 days for realized vol calculation
  S_vol_min: [0.5]                # Fixed: Minimum vol scaler (50% compression)
  S_vol_max: [1.5]                # Fixed: Maximum vol scaler (150% expansion)

  # ===========================================================================
  # TIER 4: VIX COMPRESSION MODULATOR (Fixed at defaults for Phase 1)
  # ===========================================================================
  # Will optimize in Phase 2 based on Phase 1 winners

  vix_ema_period: [50]   # Fixed: VIX EMA smoothing (50-day)
  alpha_VIX: [2.0, 3.0]       # Fixed: VIX compression strength

  # ===========================================================================
  # TIER 5: DRAWDOWN GOVERNOR (Fixed at defaults for Phase 1)
  # ===========================================================================
  # Will optimize in Phase 2 based on Phase 1 winners

  DD_soft: [0.10, 0.05]   # Fixed: -10% DD starts compression (default: 0.10)
  DD_hard: [0.15, 0.25]   # Fixed: -20% DD full compression (default: 0.20)
  p_min: [0.0]      # Fixed: Minimum exposure multiplier at DD_hard

  # ===========================================================================
  # TIER 6: REBALANCING (Fixed at defaults for Phase 1)
  # ===========================================================================

  rebalance_threshold: [0.025]  # Fixed: 2.5% drift triggers rebalance

# Optional Constraints
# --------------------
# Safety limits to prevent accidental large-scale runs

# Maximum total combinations to run
# Current combinations: 243 (3^5)
max_combinations: 300

# Checkpoint interval
# Save progress every N backtests for resume capability
checkpoint_interval: 50

# Expected Output
# ---------------
# output/grid_search_Hierarchical_Adaptive_v2_YYYYMMDD_HHMMSS/
# ├── summary_comparison.csv   # Metrics for all 243 runs (sortable)
# ├── run_config.csv          # Parameter mapping (which run = which params)
# ├── parameters.yaml         # Copy of this config file
# ├── README.txt             # Summary statistics and top performers
# ├── run_0001/              # First parameter combination
# │   ├── portfolio_daily.csv
# │   ├── trades.csv
# │   └── summary.csv
# ├── run_0002/              # Second parameter combination
# │   ├── portfolio_daily.csv
# │   ├── trades.csv
# │   └── summary.csv
# └── ... (241 more runs)

# Usage
# -----
# jutsu grid-search --config grid-configs/examples/grid_search_hierarchical_adaptive_v2.yaml
#
# After completion:
# 1. Open summary_comparison.csv
# 2. Sort by Sortino Ratio (highest to lowest)
# 3. Review top 20-50 parameter combinations
# 4. Look for consistent patterns:
#    - Do certain measurement_noise values consistently outperform?
#    - What T_max values appear most often in top performers?
#    - What k_trend values provide best risk-adjusted returns?
#    - Are there patterns in Kalman smoothing parameters?
# 5. Identify parameter stability:
#    - Do top performers cluster around specific values?
#    - Or do parameters vary widely (sign of overfitting)?
# 6. Compare to baselines:
#    - v2 vs v1 (discrete regime vs continuous exposure)
#    - v2 vs buy-and-hold QQQ/TQQQ
# 7. Next steps:
#    - Run Phase 2 grid search on modulator parameters
#    - Run WFO to validate robustness across time periods
#    - Optimize rebalancing threshold if needed

# Research Suggestions
# --------------------
# STAGED OPTIMIZATION APPROACH:
#
# Phase 1 (This Config): Core Trend/Exposure Parameters (243 runs)
# - Validates fundamental v2 paradigm shift
# - Identifies optimal Kalman filter settings
# - Finds best T_max and k_trend for continuous exposure
# - All modulators at defaults (control variables)
#
# Phase 2 (Next): Modulator Optimization (729 runs)
# - Fix Phase 1 winners for measurement_noise, smoothness, T_max, k_trend
# - Optimize volatility modulator: sigma_target_multiplier, S_vol_min/max
# - Optimize VIX modulator: vix_ema_period, alpha_VIX
# - Optimize DD governor: DD_soft, DD_hard, p_min
# - 3^6 = 729 combinations
#
# Phase 3: Fine-Tuning (81 runs)
# - Fix Phase 1 + Phase 2 winners
# - Optimize rebalancing threshold: [0.015, 0.025, 0.035]
# - Optimize exposure bounds: E_min, E_max
# - Test sigma_lookback variations
# - 3^4 = 81 combinations
#
# Phase 4: Walk-Forward Optimization (Validation)
# - Use best parameters from Phases 1-3
# - Run WFO to validate robustness across time periods
# - Check parameter stability (winners consistent across windows?)
# - Validate performance in different market conditions

# Performance Expectations
# ------------------------
# Based on v1 baseline and v2 architectural improvements:
#
# MINIMUM SUCCESS CRITERIA:
# - Sortino Ratio: >1.8 (vs v1's >1.5)
# - Max Drawdown: <20% (vs v1's <25%)
# - Win Rate: >55% (vs v1's >50%)
# - Calmar Ratio: >1.2 (vs v1's >1.0)
#
# v2 SPECIFIC IMPROVEMENTS (vs v1):
# - Smoother exposure transitions (continuous vs discrete)
# - Better risk-adjusted returns (exposure scaling vs binary positions)
# - Reduced whipsaw (volatility modulator prevents overreaction)
# - Improved drawdown control (DD governor linear compression)
# - Better capital efficiency (QQQ + TQQQ mapping vs QQQ/TQQQ/SQQQ/CASH)
#
# REGIME PERFORMANCE EXPECTATIONS:
# - Strong Trends (T_norm near ±1): High exposure (near E_max = 1.3x)
# - Moderate Trends (T_norm mid-range): Balanced exposure (near 1.0x)
# - Weak Trends (T_norm near 0): Low exposure (near E_min = 0.5x)
# - High Volatility: Vol modulator compresses exposure
# - VIX Spikes: VIX modulator provides defensive compression
# - Drawdowns: DD governor prevents exposure expansion during losses

# Analysis Checklist
# -------------------
# After grid search completes:
#
# PARAMETER ANALYSIS:
# - [ ] Top 50 runs: Do measurement_noise values cluster?
# - [ ] Top 50 runs: Do osc_smoothness/strength_smoothness values cluster?
# - [ ] Top 50 runs: What T_max values appear most often? (50, 60, or 70?)
# - [ ] Top 50 runs: What k_trend values dominate? (0.2, 0.3, or 0.4?)
# - [ ] Parameter stability: Do results vary wildly or show clear winners?
# - [ ] Interaction effects: Do certain parameter combos work better together?
#
# PERFORMANCE ANALYSIS:
# - [ ] Compare best v2 vs best v1 (continuous vs discrete paradigm)
# - [ ] Analyze exposure distribution: Is E_t using full [0.5, 1.3] range?
# - [ ] Check rebalancing frequency: Is 2.5% threshold appropriate?
# - [ ] Review trade quality: win rate, avg win/loss, profit factor
# - [ ] Verify QQQ/TQQQ mapping: Does w_TQQQ only appear when E_t > 1.0?
#
# RISK ANALYSIS:
# - [ ] Max drawdown: Does continuous exposure improve vs v1 discrete?
# - [ ] Drawdown recovery: How quickly does strategy recover from losses?
# - [ ] Exposure behavior during 2020 COVID crash (critical test)
# - [ ] Check for whipsaw: Are transitions smooth or erratic?
#
# ROBUSTNESS CHECKS:
# - [ ] Performance across market regimes: bull, bear, chop
# - [ ] Consistency: Do top performers work across entire period?
# - [ ] Overfitting signs: Are top performers widely separated in param space?
# - [ ] Paradigm validation: Does continuous exposure justify complexity?
#
# DECISION CRITERIA:
# ✅ PROCEED TO PHASE 2: Top performers cluster, clear parameter winners
# ⚠️  INVESTIGATE: Mixed results, need deeper analysis
# ❌ REVISIT DESIGN: Poor performance, paradigm not validated
