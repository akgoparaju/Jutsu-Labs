# Grid Search Configuration for Hierarchical Adaptive v2.6
# ========================================================================
# Grid Search: 243 runs (3^5 parameter combinations)
# Validates v2.6 SQQQ capability (long/short flexibility)
#
# v2.6 Changes from v2.5:
# ----------------------
# 1. SQQQ capability: 4-weight position mapping (QQQ, TQQQ, SQQQ, cash)
# 2. Extended E_min: Can now be negative (net short exposure via long SQQQ)
# 3. Added leveraged_short_symbol parameter (SQQQ)
# 4. All v2.5 features preserved (asymmetric DD governor, 5-tier engine)
#
# Strategy Overview (v2.6 SQQQ Extension):
# -----------------------------------------
# v2.5: Long-side only (QQQ + TQQQ + cash)
# v2.6: Long/short flexibility (QQQ + TQQQ + SQQQ + cash)
#
# Key Innovation: LONG SQQQ positions provide short QQQ exposure
# - SQQQ is 3x inverse ETF (-3x QQQ exposure)
# - Buying SQQQ shares = shorting QQQ exposure (NOT short selling SQQQ)
# - Enables net short positioning through long-only trades
#
# Position Mapping (4 regions):
# - E_t ≤ -1.0: Leveraged short (QQQ + SQQQ, fully invested)
#   w_SQQQ = (1 - E_t) / 4, w_QQQ = 1 - w_SQQQ
# - -1.0 < E_t < 0: Defensive short (SQQQ + cash)
#   w_SQQQ = -E_t / 3, w_cash = 1 - w_SQQQ
# - 0 ≤ E_t ≤ 1.0: Defensive long (v2.5 logic - QQQ + cash)
#   w_QQQ = E_t, w_cash = 1 - E_t
# - E_t > 1.0: Leveraged long (v2.5 logic - QQQ + TQQQ)
#   w_TQQQ = (E_t - 1) / 2, w_QQQ = 1 - w_TQQQ
#
# 5-Tier Exposure Engine (Same as v2.5):
# - TIER 1: Kalman trend → T_norm ∈ [-1, +1]
# - TIER 2: Baseline exposure → E_trend = 1.0 + k_trend * T_norm
# - TIER 3: Volatility modulator → S_vol = clip(σ_target / σ_real, S_min, S_max)
# - TIER 4: VIX compression → P_VIX = 1 / (1 + α_VIX * (R_VIX - 1))
# - TIER 5: Drawdown governor → P_DD (v2.5 ASYMMETRIC - works for negative E!)
#
# Expected Improvements over v2.5:
# - Bear market performance: Better downside protection through SQQQ
# - Exposure range: Full [-0.5, 1.5] utilization vs v2.5's [0.4, 1.5]
# - Flexibility: Can profit from both bull and bear markets
# - Drawdown control: More defensive tools available
#
# Grid Search Strategy:
# ---------------------
# Focus: Testing SQQQ capability with v2.5-proven parameter ranges
# - Use same parameter ranges as v2.5 Phase 1
# - Add E_min grid to test negative exposure
# - All modulators at v2.5 defaults
# - Compare to v2.5 to validate SQQQ benefit
#
# Total combinations: 243 runs (3^5)
# Estimated runtime: 30-45 minutes

# Strategy to optimize
strategy: "Hierarchical_Adaptive_v2_6"

# Symbol Sets
# -----------
# v2.6 requires 4 symbols (v2.5 + SQQQ):
# - Added SQQQ for short exposure capability
# - VIX used for compression modulator
symbol_sets:
  - name: "QQQ_TQQQ_SQQQ_VIX"
    signal_symbol: "QQQ"                # Kalman filter calculations
    core_long_symbol: "QQQ"             # 1x base allocation
    leveraged_long_symbol: "TQQQ"       # 3x leveraged overlay (when E_t > 1.0)
    leveraged_short_symbol: "SQQQ"      # 3x inverse (when E_t < 0) - NEW in v2.6
    vix_symbol: "VIX"                   # Volatility compression modulator

# Base Configuration
# ------------------
# Fixed settings applied to ALL backtests
base_config:
  # Date range - Full history (2010-2024)
  # Includes: Financial crisis recovery, bull market, COVID crash, recovery
  start_date: "2010-03-01"
  end_date: "2025-11-01"

  # Market data
  timeframe: "1D"

  # Portfolio settings
  initial_capital: 10000  # $10,000 starting capital
  commission: 0.0          # $0.00 per trade
  slippage: 0.0005         # 0.05% per trade

# Parameters to Optimize
# ----------------------
# Grid Search: Core parameters (same ranges as v2.5 Phase 1)
# NEW: E_min grid includes negative values to test SQQQ capability

parameters:
  # ===========================================================================
  # TIER 1: KALMAN FILTER PARAMETERS (3 parameters optimized)
  # ===========================================================================
  # Controls trend calculation and normalization

  # Measurement noise (higher = smoother Kalman filter)
  # Default: 2000.0, Range: [1000.0, 5000.0]
  measurement_noise: [1000.0, 2000.0, 3000.0]  # 3 values

  # Oscillator smoothness (higher = smoother oscillator)
  # Default: 15, Range: [10, 20]
  osc_smoothness: [15]  # 1 value (fixed)

  # Strength smoothness (higher = smoother trend strength)
  # Default: 15, Range: [10, 20]
  strength_smoothness: [15]  # 1 value (fixed)

  # Process noise parameters (fixed at defaults)
  process_noise_1: [0.01]  # Fixed
  process_noise_2: [0.01]  # Fixed

  # ===========================================================================
  # TIER 2: BASELINE EXPOSURE PARAMETERS (2 parameters optimized)
  # ===========================================================================
  # Controls E_trend = 1.0 + k_trend * T_norm

  # Trend normalization max (CRITICAL parameter)
  # Default: 60, Range: [50, 70]
  T_max: [50, 60, 70]  # 3 values

  # Baseline exposure slope (CRITICAL parameter)
  # Default: 0.3, Range: [0.2, 0.7]
  k_trend: [0.3, 0.5, 0.7]  # 3 values

  # Exposure bounds
  # v2.6 CHANGE: E_min can now be negative (test SQQQ capability)
  E_min: [-0.1,-0.2,-0.3, 0.4, 0.6, 0.8]  # 3 values: negative (short), neutral, long-only
  E_max: [1.5]             # Fixed: Maximum exposure (1.5x leverage cap)

  # ===========================================================================
  # TIER 3: VOLATILITY MODULATOR (Fixed at defaults)
  # ===========================================================================

  sigma_target_multiplier: [0.8]  # Fixed: σ_target = historical_vol × 0.8
  realized_vol_lookback: [20]     # Fixed: 20 days for realized vol calculation
  S_vol_min: [0.5]                # Fixed: Minimum vol scaler (50% compression)
  S_vol_max: [1.5]                # Fixed: Maximum vol scaler (150% expansion)

  # ===========================================================================
  # TIER 4: VIX COMPRESSION MODULATOR (Fixed at defaults)
  # ===========================================================================

  vix_ema_period: [50]   # Fixed: VIX EMA smoothing (50-day)
  alpha_VIX: [2.0]       # Fixed: VIX compression strength

  # ===========================================================================
  # TIER 5: DRAWDOWN GOVERNOR (v2.5 asymmetric formula)
  # ===========================================================================
  # v2.5's asymmetric formula works correctly for negative exposure!
  # No changes needed for v2.6

  DD_soft: [0.08, 0.10]   # Fixed: 10% DD starts compression
  DD_hard: [0.20, 0.25]   # Fixed: 20% DD full compression
  p_min: [0.0]      # Fixed: Minimum exposure multiplier at DD_hard

  # ===========================================================================
  # TIER 6: REBALANCING (Fixed at defaults)
  # ===========================================================================

  rebalance_threshold: [0.025]  # Fixed: 2.5% drift triggers rebalance

# Optional Constraints
# --------------------

# Maximum total combinations to run
# Current combinations: 3^5 = 243
max_combinations: 300

# Checkpoint interval
checkpoint_interval: 50

# Expected Output
# ---------------
# output/grid_search_Hierarchical_Adaptive_v2_6_YYYYMMDD_HHMMSS/
# ├── summary_comparison.csv   # Metrics for all 243 runs
# ├── run_config.csv          # Parameter mapping
# ├── parameters.yaml         # Copy of this config
# ├── README.txt             # Summary statistics
# └── run_XXXX/              # Individual runs

# Usage
# -----
# jutsu grid-search --config grid-configs/grid_search_hierarchical_adaptive_v2_6.yaml
#
# After completion:
# 1. Compare to v2.5 baseline (same parameter ranges)
# 2. Analyze SQQQ allocation frequency and effectiveness
# 3. Review performance in bear markets (2020 COVID crash)
# 4. Check E_min utilization:
#    - Does E_min = -0.5 improve bear market performance?
#    - Does E_min = 0.0 provide good neutral baseline?
#    - Does E_min = 0.4 match v2.5 long-only performance?
# 5. Validate 4-weight position mapping correctness
# 6. Decide on Phase 2 modulator optimization
#
# v2.6 SPECIFIC ANALYSIS:
# -----------------------
# SQQQ CAPABILITY VALIDATION:
# - [ ] Does v2.6 actually use SQQQ? (Check trade logs)
# - [ ] Min exposure reached: Does it reach E_min = -0.5?
# - [ ] SQQQ allocation: Correct weights in all 4 regions?
# - [ ] Bear market performance: Better than v2.5?
# - [ ] COVID crash (Feb-Mar 2020): Did SQQQ help?
#
# POSITION MAPPING VALIDATION:
# - [ ] Region 1 (E ≤ -1.0): QQQ + SQQQ weights sum to 1.0?
# - [ ] Region 2 (-1.0 < E < 0): SQQQ + cash weights sum to 1.0?
# - [ ] Region 3 (0 ≤ E ≤ 1.0): QQQ + cash = v2.5 behavior?
# - [ ] Region 4 (E > 1.0): QQQ + TQQQ = v2.5 behavior?
# - [ ] Net exposure math: Verify E_net = w_QQQ + 3*w_TQQQ - 3*w_SQQQ
#
# PERFORMANCE COMPARISON (v2.6 vs v2.5):
# - [ ] Max drawdown: Is v2.6 better?
# - [ ] Sortino ratio: Improvement with short capability?
# - [ ] Win rate: Maintained or improved?
# - [ ] Bear market returns: Better with SQQQ?
# - [ ] Bull market returns: No degradation?
#
# E_MIN SENSITIVITY ANALYSIS:
# - [ ] E_min = -0.5: Performance vs risk trade-off?
# - [ ] E_min = 0.0: Neutral baseline comparison?
# - [ ] E_min = 0.4: Should match v2.5 performance?
# - [ ] Optimal E_min: Which value dominates top performers?
#
# RISK ANALYSIS:
# - [ ] Whipsaw risk: SQQQ transitions smooth?
# - [ ] Rebalancing frequency: Increased with 4 weights?
# - [ ] Transaction costs: Impact of more trading?
# - [ ] SQQQ tracking error: Performance vs -3x QQQ?
#
# DECISION CRITERIA:
# ✅ SUCCESS: v2.6 improves bear markets, maintains bull markets
# ⚠️  INVESTIGATE: Mixed results, sensitivity to E_min
# ❌ ROLLBACK: v2.6 worse than v2.5, stick with long-only

# v2.6 Testing Notes
# ------------------
# This grid search validates that v2.6 SQQQ capability:
# 1. Actually allows short positioning (E < 0) through long SQQQ
# 2. Improves bear market performance vs v2.5
# 3. Maintains bull market performance (no degradation)
# 4. Uses full exposure range [-0.5, 1.5]
#
# Key validation points:
# - v2.5: Limited to [E_min, 1.5] = [0.4, 1.5] long-only
# - v2.6: Extended to [-0.5, 1.5] with SQQQ capability
# - Expected: Better drawdown control, improved Sortino
# - Risk: More complexity, potential whipsaw
#
# Comparison workflow:
# 1. Run this v2.6 grid search (243 runs)
# 2. Compare best v2.6 to best v2.5 (same param ranges)
# 3. Analyze min_exposure_reached (should be negative!)
# 4. Check SQQQ allocation frequency and effectiveness
# 5. Validate COVID crash performance (Feb-Mar 2020)
# 6. Make go/no-go decision for v2.6 adoption
