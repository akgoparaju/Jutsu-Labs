# Live Trading Configuration - Jutsu Labs
# Version: 2.0 (Flat Structure - PRD v2.0.1 Compliant)
# Strategy: Hierarchical Adaptive v3.5b ("Titan Config")
#
# IMPORTANT: This config uses FLAT parameter structure.
# All 32 strategy parameters are directly under 'parameters' key.
# This matches grid search output format and strategy __init__ signature.

# ==============================================================================
# ENVIRONMENT SETTINGS
# ==============================================================================
version: "2.0"
environment: "dry_run"  # Options: dry_run, paper, live

# ==============================================================================
# PORTFOLIO SETTINGS
# ==============================================================================
portfolio:
  initial_capital: 10000  # Starting capital in USD (default: $10,000)  # Options: dry_run, paper, live

# ==============================================================================
# STRATEGY CONFIGURATION (32 FLAT PARAMETERS)
# ==============================================================================
strategy:
  name: "Hierarchical_Adaptive_v3_5b"

  # All parameters FLAT - matches strategy __init__ signature exactly
  parameters:
    # ------------------------------------------------------------------
    # KALMAN TREND PARAMETERS (6 parameters)
    # ------------------------------------------------------------------
    measurement_noise: 3000.0
    process_noise_1: 0.01
    process_noise_2: 0.01
    osc_smoothness: 15
    strength_smoothness: 15
    T_max: 50.0

    # ------------------------------------------------------------------
    # STRUCTURAL TREND PARAMETERS (4 parameters)
    # ------------------------------------------------------------------
    sma_fast: 40
    sma_slow: 140
    t_norm_bull_thresh: 0.05
    t_norm_bear_thresh: -0.3

    # ------------------------------------------------------------------
    # VOLATILITY Z-SCORE PARAMETERS (4 parameters)
    # ------------------------------------------------------------------
    realized_vol_window: 21
    vol_baseline_window: 200
    upper_thresh_z: 1.0
    lower_thresh_z: 0.2

    # ------------------------------------------------------------------
    # VOL-CRUSH OVERRIDE (2 parameters)
    # ------------------------------------------------------------------
    vol_crush_threshold: -0.15
    vol_crush_lookback: 5

    # ------------------------------------------------------------------
    # ALLOCATION PARAMETERS (1 parameter)
    # ------------------------------------------------------------------
    leverage_scalar: 1.0

    # ------------------------------------------------------------------
    # INSTRUMENT TOGGLES (2 parameters)
    # ------------------------------------------------------------------
    use_inverse_hedge: false
    w_PSQ_max: 0.5

    # ------------------------------------------------------------------
    # TREASURY OVERLAY PARAMETERS (5 parameters)
    # ------------------------------------------------------------------
    allow_treasury: true
    bond_sma_fast: 20
    bond_sma_slow: 60
    max_bond_weight: 0.4
    treasury_trend_symbol: "TLT"

    # ------------------------------------------------------------------
    # REBALANCING CONTROL (1 parameter)
    # ------------------------------------------------------------------
    rebalance_threshold: 0.025

    # ------------------------------------------------------------------
    # EXECUTION TIMING (1 parameter)
    # ------------------------------------------------------------------
    execution_time: "15min_after_open"  # Options: open, 15min_after_open, 15min_before_close, 5min_before_close, close

    # ------------------------------------------------------------------
    # SYMBOL CONFIGURATION (6 parameters)
    # ------------------------------------------------------------------
    signal_symbol: "QQQ"
    core_long_symbol: "QQQ"
    leveraged_long_symbol: "TQQQ"
    inverse_hedge_symbol: "PSQ"
    bull_bond_symbol: "TMF"
    bear_bond_symbol: "TMV"

# ==============================================================================
# EXECUTION SETTINGS
# ==============================================================================
execution:
  rebalance_threshold_pct: 5.0      # Don't trade if position diff <5%
  max_slippage_pct: 0.5             # CONFIGURABLE MAX SLIPPAGE (user requirement)
  slippage_warning_pct: 0.3         # Warn if slippage >0.3%
  slippage_abort_pct: 1.0           # Abort if slippage >1.0%
  max_order_retries: 3              # Retry count for partial fills
  retry_delay_seconds: 5            # Wait between retries
  max_buying_power_pct: 95          # Use max 95% of buying power (5% buffer)

  # Order execution sequence
  order_sequence:
    - "SELL"  # Sell first (raise cash)
    - "BUY"   # Buy second

# ==============================================================================
# TIMING SCHEDULE (EST)
# ==============================================================================
schedule:
  auth_check_time: "15:49:30"       # Pre-execution OAuth validation
  data_fetch_time: "15:50:00"       # Historical data fetch
  execution_time: "15:55:00"        # Order execution window
  validation_time: "16:15:00"       # Post-market validation

# ==============================================================================
# RISK LIMITS
# ==============================================================================
risk:
  max_position_size_pct: 100        # Per symbol (TQQQ can be 100%)
  max_total_leverage: 2.0           # Hard cap on total exposure
  min_cash_pct: 5.0                 # Always keep 5% cash reserve

  # Abort conditions (critical failures)
  abort_conditions:
    - "auth_failure"
    - "corporate_action_detected"
    - "extreme_slippage"
    - "account_equity_mismatch"
    - "state_corruption"

# ==============================================================================
# STATE MANAGEMENT
# ==============================================================================
state:
  file_path: "state/state.json"
  backup_enabled: true
  backup_path: "state/backups/"
  reconciliation_threshold_pct: 2.0  # Warn if state drift >2%

# ==============================================================================
# ALERTS (Phase 3)
# ==============================================================================
alerts:
  sms_enabled: false               # Enable SMS alerts (Phase 3)
  email_enabled: true              # Enable email alerts

  # Critical alert conditions
  critical_conditions:
    - "auth_failure"
    - "corporate_action_detected"
    - "slippage_exceeded"
    - "position_drift_high"
    - "data_fetch_timeout"

  # Contact information (populate from .env)
  sms_number: "${ALERT_SMS_NUMBER}"
  email_address: "${ALERT_EMAIL}"

# ==============================================================================
# SCHWAB API CONFIGURATION
# ==============================================================================
schwab:
  api_key: "${SCHWAB_API_KEY}"           # From .env
  api_secret: "${SCHWAB_API_SECRET}"     # From .env
  redirect_uri: "https://localhost:8182"
  token_path: "token.json"
  account_number: "${SCHWAB_ACCOUNT_NUMBER}"
  environment: "paper"                   # paper or live

  # Rate limiting
  rate_limit:
    market_data_per_second: 2
    trading_per_second: 1

# ==============================================================================
# DATABASE CONFIGURATION
# ==============================================================================
database:
  url: "sqlite:///data/live_trading.db"  # Separate DB for live trading
  echo: false
  pool_size: 5

# ==============================================================================
# LOGGING
# ==============================================================================
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  file_path: "logs/live_trading_{date}.log"
  retention_days: 90
  format: "%(asctime)s | %(levelname)s | %(name)s | %(message)s"

  # Module-specific log levels
  modules:
    LIVE.DATA_FETCHER: "INFO"
    LIVE.STRATEGY_RUNNER: "INFO"
    LIVE.ORDER_EXECUTOR: "INFO"
    LIVE.STATE: "INFO"
    LIVE.MARKET_CALENDAR: "WARNING"

# ==============================================================================
# VALIDATION (Phase 1)
# ==============================================================================
validation:
  backtest_rerun_enabled: true
  price_drift_threshold_pct: 0.5     # Warn if 15:55 vs 16:00 >0.5%
  logic_match_threshold_pct: 95      # Require >=95% logic match over 20 days

  # Corporate action detection
  corporate_action:
    price_drop_threshold_pct: 20     # Flag if >20% single-day drop
    lookback_days: 5                 # Check last 5 days

# ==============================================================================
# DATA FETCHING
# ==============================================================================
data:
  historical_lookback: 250           # Trading days to fetch
  quote_timeout_seconds: 30          # Max time for quote fetch
  historical_timeout_seconds: 60     # Max time for historical data

  # Validation
  min_bars_required: 240             # Require at least 240 bars
  max_price_gap_pct: 10              # Flag if bar-to-bar gap >10%

# ==============================================================================
# PERFORMANCE TARGETS (For Monitoring)
# ==============================================================================
performance:
  phase_0:
    oauth_auth_seconds: 1.0
    quote_fetch_seconds: 0.5
    market_calendar_seconds: 0.1

  phase_1:
    historical_fetch_seconds: 5.0
    quote_fetch_all_seconds: 2.0
    strategy_execution_seconds: 3.0
    total_workflow_seconds: 20.0
    state_save_load_seconds: 0.1

  phase_2:
    order_execution_per_order: 5.0
    fill_validation_seconds: 2.0
    total_workflow_seconds: 60.0

# ==============================================================================
# HEALTH MONITORING (Phase 3)
# ==============================================================================
health:
  check_interval_hours: 6
  checks:
    - "api_connectivity"
    - "state_file_integrity"
    - "disk_space_gb"
    - "cron_schedule"

  thresholds:
    min_disk_space_gb: 1.0
    max_log_age_days: 7

# ==============================================================================
# NOTES
# ==============================================================================
# Version 2.0 Changes (PRD v2.0.1 Compliance):
# - Converted nested strategy params to FLAT structure
# - All 32 parameters directly under strategy.parameters
# - Parameter names match strategy __init__ signature exactly
# - Added 5min_before_close as valid execution_time option
# - Added database configuration section
#
# Key User Requirements:
# 1. NO FRACTIONAL SHARES - All position calculations round DOWN
# 2. CONFIGURABLE SLIPPAGE - max_slippage_pct = 0.5% (default)
# 3. ATOMIC STATE WRITES - Temp file + rename pattern
# 4. CORPORATE ACTION DETECTION - >20% price drop triggers abort
